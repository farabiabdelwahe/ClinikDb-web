<section class="pricing-section" id="pricing">
  <div class="pricing-container">
    <!-- Header -->
    <div class="pricing-header">
      <h2 class="pricing-title">{{ "pricing.title" | translate }}</h2>
      <p class="pricing-subtitle">{{ "pricing.subtitle" | translate }}</p>
    </div>

    <!-- Referral / Commission (feature gated) -->
    <div *ngIf="featureAgentCommission" class="referral-wrapper">
      <mat-card
        class="referral-card"
        [class.referral-collapsed]="promoState().status === 'collapsed'"
      >
        <div class="referral-header">
          <div class="referral-heading">
            <lucide-angular
              [img]="Gift"
              size="24"
              class="referral-gift"
            ></lucide-angular>
            <h3>{{ "pricing.referral.title" | translate }}</h3>
            <span
              *ngIf="promoState().status === 'applied'"
              class="active-badge"
            >
              {{ discountPercentage }}%
            </span>
          </div>

          <button
            type="button"
            class="toggle-referral"
            (click)="toggleReferralPanel()"
            [attr.aria-expanded]="promoState().status !== 'collapsed'"
            [attr.aria-controls]="'referral-panel'"
            [attr.aria-label]="
              promoState().status === 'collapsed'
                ? ('pricing.referral.openPanel' | translate)
                : ('pricing.referral.closePanel' | translate)
            "
          >
            <mat-icon>
              {{
                promoState().status === "collapsed"
                  ? "expand_more"
                  : "expand_less"
              }}
            </mat-icon>
          </button>
        </div>

        <div
          id="referral-panel"
          class="referral-body"
          *ngIf="promoState().status !== 'collapsed'"
        >
          <!-- Applied State -->
          <div
            *ngIf="promoState().status === 'applied'"
            class="referral-applied"
          >
            <div class="applied-left">
              <lucide-angular
                [img]="CheckCircle"
                size="28"
                class="applied-icon"
              ></lucide-angular>
              <div class="applied-text">
                <p class="title">
                  {{ "pricing.referral.applied" | translate }}
                </p>
                <p class="code-line">
                  {{ promoState().code }} •
                  {{
                    "pricing.referral.discount"
                      | translate: { percentage: discountPercentage }
                  }}
                </p>
                <p class="saving-hint">
                  {{ "pricing.referral.activeSavingsHint" | translate }}
                </p>
              </div>
            </div>
            <div class="applied-actions">
              <button
                mat-stroked-button
                color="primary"
                (click)="removeReferral()"
              >
                {{ "pricing.referral.remove" | translate }}
              </button>
            </div>
          </div>

          <!-- Entry / Validation State -->
          <div *ngIf="promoState().status !== 'applied'" class="referral-entry">
            <div class="referral-field">
              <label class="referral-label" for="referral-code"
                >{{ "pricing.referral.placeholder" | translate }}</label
              >
              <div
                class="referral-input-wrapper"
                [class.disabled]="promoState().status === 'validating'"
              >
                <input
                  id="referral-code"
                  type="text"
                  class="referral-input"
                  [value]="promoInput"
                  (input)="onReferralInput($event.target.value)"
                  [placeholder]="'pricing.referral.example' | translate"
                  autocomplete="off"
                  spellcheck="false"
                  maxlength="18"
                  aria-describedby="referral-help referral-status"
                  [attr.aria-invalid]="promoState().status === 'error'"
                  [disabled]="promoState().status === 'validating'"
                />
                <lucide-angular
                  class="referral-icon"
                  [img]="Tag"
                  size="18"
                  aria-hidden="true"
                ></lucide-angular>
              </div>
              <p id="referral-help" class="referral-hint">
                {{ "pricing.referral.hint" | translate }}
              </p>
            </div>

            <div class="referral-actions">
              <button
                mat-raised-button
                color="primary"
                (click)="applyReferral()"
                [disabled]="!canApply() || promoState().status === 'validating'"
              >
                <ng-container [ngSwitch]="promoState().status">
                  <span *ngSwitchCase="'validating'" class="btn-validating">
                    <mat-progress-spinner
                      mode="indeterminate"
                      diameter="18"
                      strokeWidth="3"
                    ></mat-progress-spinner>
                    {{ "pricing.referral.validating" | translate }}
                  </span>
                  <span *ngSwitchDefault>{{
                    "pricing.referral.applyButton" | translate
                  }}</span>
                </ng-container>
              </button>
            </div>

            <div
              id="referral-status"
              class="referral-status"
              [class.error]="promoState().status === 'error'"
              [class.validating]="promoState().status === 'validating'"
              [class.info]="promoState().status === 'open'"
              aria-live="polite"
            >
              {{ t(promoState().messageKey, promoState().messageParams) }}
            </div>
          </div>

          <mat-divider></mat-divider>

          <div class="referral-footnote">
            <mat-icon>info</mat-icon>
            <p *ngIf="region === 'tn'">
              {{ "pricing.referral.footnoteTN" | translate }}
            </p>
            <p *ngIf="region !== 'tn'">
              {{ "pricing.referral.footnoteIntl" | translate }}
            </p>
          </div>
        </div>
      </mat-card>
    </div>

    <!-- Pricing Cards -->
    <div class="pricing-grid">
      <mat-card
        *ngFor="let plan of plans; trackBy: trackByPlan"
        class="pricing-card"
        [class.highlighted]="plan.highlighted"
        [class.has-gradient]="plan.gradient"
      >
        <!-- Badge -->
        <div *ngIf="plan.badge" class="plan-badge-container">
          <span class="plan-badge">{{ plan.badge }}</span>
        </div>

        <!-- Card Header -->
        <div class="card-header" [style.background]="plan.gradient">
          <div class="plan-icon-wrapper">
            <lucide-angular
              [img]="plan.icon"
              size="32"
              class="plan-icon"
            ></lucide-angular>
          </div>
          <h3 class="plan-name">{{ plan.name }}</h3>
          <p class="plan-description">{{ plan.description }}</p>
        </div>

        <mat-card-content class="card-content">
          <div class="pricing-display">
            <div class="price-row">
              <span *ngIf="plan.price === 0" class="price-free">{{
                "pricing.plans.free.name" | translate
              }}</span>
              <div *ngIf="plan.price > 0" class="price-container">
                <span class="currency">{{ currencySymbol() }}</span>
                <span
                  class="price-amount"
                  [class.discounted]="discountPercentage > 0"
                >
                  {{ getDiscountedPrice(plan.price) }}
                </span>
                <span class="price-period">/{{ plan.period }}</span>
              </div>
            </div>

            <div
              *ngIf="plan.price > 0 && discountPercentage > 0"
              class="discount-info"
            >
              <span class="original-price"
                >{{ currencySymbol() }}{{ plan.price }}</span
              >
              <mat-chip class="savings-chip">
                {{
                  "pricing.save"
                    | translate
                      : { amount: plan.price - getDiscountedPrice(plan.price) }
                }}
              </mat-chip>
            </div>
          </div>

          <mat-divider class="features-divider"></mat-divider>

          <ul class="features-list">
            <li *ngFor="let feature of plan.features" class="feature-item">
              <lucide-angular
                [img]="CheckCircle"
                size="20"
                class="feature-icon"
              ></lucide-angular>
              <span class="feature-text">{{ feature }}</span>
            </li>
          </ul>

          <button
            mat-raised-button
            [color]="plan.highlighted ? 'primary' : ''"
            class="plan-button"
            [class.primary-button]="plan.highlighted"
            (click)="subscribe(plan)"
          >
            {{ plan.buttonText }}
          </button>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Footer Notes -->
    <div class="pricing-footer">
      <div class="enterprise-section">
        <mat-icon class="enterprise-icon">business</mat-icon>
        <div class="enterprise-content">
          <p class="enterprise-text">
            {{ "pricing.footer.enterprise" | translate }}
          </p>
          <a href="#contact" class="enterprise-link">
            {{ "pricing.footer.contactTeam" | translate }} →
          </a>
        </div>
      </div>

      <div class="features-note">
        <mat-icon>verified_user</mat-icon>
        <p>{{ "pricing.footer.included" | translate }}</p>
      </div>
    </div>

    <!-- Partner Info (Feature gated) -->
    <div class="partner-info" *ngIf="showPartnerInfo()">
      <mat-card class="partner-card">
        <mat-card-content>
          <div class="partner-content">
            <div class="partner-icon-wrapper">
              <mat-icon class="partner-icon">handshake</mat-icon>
            </div>
            <div class="partner-text">
              <h4 class="partner-title">
                {{ "pricing.partner.title" | translate }}
              </h4>
              <p class="partner-description">
                {{ "pricing.partner.description" | translate }}
              </p>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>
</section>
